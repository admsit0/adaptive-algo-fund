# ==============================================================================
# Clustering Pipeline Configuration
# ==============================================================================
# Creates cluster universes from algo personality and factor exposures.
#
# Usage:
#   python -m athenai.scripts.run_clustering --config configs/clustering.yaml
# ==============================================================================

# --- Pipeline Metadata ---
run_id: "clustering_v1"
preprocess_run_id: "20260119_225417_8512cdac4218"    # Must exist in cache_dir
personality_run_id: "20260119_232926_111494c43caf"  # Must exist in cache_dir
cache_dir: "data/cache"

# --- Factor Timeseries Configuration ---
# PCA-based factor decomposition of returns
factor_config:
  pca_k: 10                    # Number of PCA factors (f_pca_1..K)
  pca_date_sampling: "W"       # Weekly sampling for PCA ("W" or "M")
  standardize_returns: true    # Z-score returns before PCA
  min_algos_pca: 500           # Minimum algos required for PCA
  pca_model_name: "pca_model.npz"
  factor_ts_name: "factor_timeseries.parquet"

# --- Algo Factor Exposures Configuration ---
# Regression of algo returns on factors
exposure_config:
  method: "ridge_ols"          # "ols" or "ridge_ols"
  ridge_lambda: 0.001          # Ridge regularization (λ=0 → OLS)
  min_obs: 120                 # Minimum observations for regression
  exposures_all_name: "algo_factor_exposures_all.parquet"
  exposures_good_name: "algo_factor_exposures_good.parquet"

# --- Cluster Sets Configuration ---
# Multi-family clustering for different algo groupings
cluster_sets:
  
  # --- Behavioral Family ---
  # Groups algos by personality + factor exposures
  - cluster_set_id: "behavioral_k100_v1"
    family: "behavioral"
    k: 100                     # Target clusters
    feature_source: "static_features"
    scaler: "robust"           # IQR-based scaling
    algorithm: "minibatch_kmeans"
    seed: 42
    min_cluster_size: 10

  # --- Correlation Embedding Family ---
  # Groups algos by return correlation structure (PCA loadings)
  - cluster_set_id: "corrpca_k60_v1"
    family: "correlation_embedding"
    k: 60
    feature_source: "pca_embedding"
    scaler: "zscore"
    algorithm: "kmeans"
    seed: 42
    min_cluster_size: 10

  # --- Alternative configurations (commented) ---
  # Uncomment to add more cluster universes
  
  # - cluster_set_id: "behavioral_k50_v1"
  #   family: "behavioral"
  #   k: 50
  #   feature_source: "static_features"
  #   scaler: "robust"
  #   algorithm: "kmeans"
  #   seed: 42
  #   min_cluster_size: 20
  
  # - cluster_set_id: "gmm_k30_v1"
  #   family: "behavioral"
  #   k: 30
  #   feature_source: "static_features"
  #   scaler: "zscore"
  #   algorithm: "gmm"
  #   seed: 42
  #   min_cluster_size: 30

# --- Cluster Timeseries Configuration ---
# Rolling features for cluster-level state
timeseries_config:
  rolling_windows:
    - 5
    - 10
    - 20
    - 60
  vol_annualization: 252       # Trading days per year
  min_samples_ratio: 0.25      # min_samples = ratio * window_size
